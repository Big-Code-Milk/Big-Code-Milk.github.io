# 2020_0622_0909

101 103 似乎是在 PORTAL 主頁面由 User 做申請

## 申請跟異動 101 ITCServicePortal_PAM_SRS_V1 - 8 頁 19-26

UC UseCase ?

帳號權限申請單 - 使用人提出資訊服務之帳號權限申請資訊後將申請單送件。

資訊服務申請單

功能列表 離開 編輯 儲存 送件， 系統功能 檢視流程圖 簽核說明

相關資料填寫與驗證，轉往承辦人流程繼續

1. 儲存 是指暫存 ? 送件 才是真的送出 ?
2. P.21 申請項目上寫的 B.服務項目與承辦人資訊 工作表 是指 圖UCPAM 101-2 ?
3. HR Master 是 table ? `資料庫表 紀錄員工`
4. 手機型號選單有獨立一張表 ?
5. 帳號權限申請流程內的 已自動化系統 / 未自動化 是指 ? `自動化 是指 邏輯/流程/排程`
6. 帳號權限申請流程內經過 PAM 是要確認權限 ? 然後符合權限就由 PAM 後端進行 CRUD / 寄信 ?
7. 企業規則第 2 項，好像沒有再圖 UCPAM 101-2 有分主次分類 ?
8. AD 帳號是指 ? 跟其他帳號權限有什麼其他區別嗎 ?
9. 名詞問題 : 黑網域 ? `管理自己內網的東西`， Mail-out 主檔 使用中 ?
10. PAM 主檔儲存欄位的 `PS：狀態 =停用，需放在停用表格；資料僅存放 "使用中" Key 才會 OK。` 是指說有另外一張表去放停用，然後此張表只放使用 ?
11. `依據(IF007) 資料判斷該設備是否已連線，若有資料則結案。` 是指判斷欄位嗎 ? `API 呼叫模組`
12. 名詞問題 : 自動月盤機制 ?
13. 需求日期是指 簽核有限制時間內簽核完 ? 還是只是申請時間之類的 ? 使用者預期時間註記

## 異動 103 ITCServicePortal_PAM_SRS_V1 - 6 頁 33-39

1. 異動 update 也要申請簽核，還是指送出申請前的異動 ?

---

看 JS UDN 看了一個小時才想到其實有不只兩份文件要看就接續

---

## 10:09

701 702 是 管理帳號權限的 PAM 功能

### 3.33 UCPAM701: [帳號權限主檔異動申請]

帳號權限主檔異動申請

申請異動 -> 簽核 -> 可以異動帳號權限特定欄位

同 UCPAM 112

### 3.34 CPAM702: [帳號權限主檔異動申請單查詢]

---

架設 PAM 環境時遇到以下問題

[ERROR] 輸出類型為類別庫的專案無法直接起始

<https://dotblogs.com.tw/jclittleworld/2018/05/24/164148>

[ERROR] 處理"無法啟動IIS Express Web伺服器"問題

<https://dotblogs.com.tw/sapphire/2017/03/10/20170310>

組態檔案不知道為啥是設定以函式庫執行而不是 api 專案，且居然沒有組態檔案 ??

看來 SAM 也是相同問題。

因為改 port 問題去翻了 ng login 底層，發現都是用 environment 環境變數去置換來置換去，可是依經驗，如果硬要去找 api 好像還是能找的到吧，這樣編譯有用嗎 ?? 疑惑

---

## 11:00

終於要開始看 code 了，原本以為文件是要繼續接續 701 702，結果原來主管文件也沒看很熟，

直接看 code 才是最快的，簡紀下剛剛所知:

101 程式前後端邏輯

流程 / 簽程 / 送件

---

`Mxic.ITC.Portal.API`

`Controllers/MixicAoiHostController.cs` 只是轉接，

進入點基本在 `Mxic.ITC.Portal.Service`

`Sign / AccountApplyFormService.cs`

Line.30 Approve

```C#
[ExposeWebAPI(true)]
        public PageQueryResult<string> Approve(SignData<AccountApplyForm> Data)
        {
            BPMService = new BpmService(MembershipStore);
            var result = Repository.Approve(Data, UserInfo.Account, HrMasterService, BPMService);
            return result;
        }
```

其他此頁面相關功能 ...

Line.142 Create 啟表單 回傳 `PageQueryResult<string>`

```C#
result = Repository.Create(Data, UserInfo.Account, HrMasterService, BPMService, new Model.Signer
            { });
            return result;
```

---

轉共用函式庫 `Mxic.ITC.Portal.Repository`

`UnitOfWork / SignRepository.cs`

共用 From 邏輯又分為

共用表單基本資料 head +

流程判斷邏輯 ( 各自不同 ) +

建立關卡邏輯

BPM 甲方系統環境界接

關卡簽核邏輯

![img](/sinda-notes/img/creatinster.png)

Line. 850 送件

```C#
     Repository.Create(Data.FormData, _mapper.Map<SIGN_FORM_MAIN, SignFormMain>(SIGN), SIGN.SIGN_FORM_ID, IsNew, nextStage);
```

這裡感覺是判斷 Data.FormData 的型別後會多載到不同的方法做不同的處理，但疑惑點是，不同方法的實作最後都有 return 值，

不知道為什麼這裡並沒有用變數去接那個 return 值，那又如何既須能夠 save change ?

總之這支 `PageQueryResult<string>` Create() 程式最後是有回傳 return response; 讓整個邏輯順利補完...

---

DB 管理工具使用以下

<https://dbeaver.io/>

PORTAL -> TEST

PAM -> PAM V2

SAM -> TEST SAM

`Region 區域化註解`

## 03:27

大致上記錄起來了，休息一下就進路細看環節。(包含啟動生命週期，怎調用之類的)

原本想說要接著先看一下前端架構，但... 光呼叫 api 的方式，就是以前比較沒接觸到的方式，果然很多山要爬...

目前看起來 專案 前後端一上，前端登入時因為預設顯示內容，其實就在呼叫 api 了，所以直接就很多筆 request 一值近來在返回，更難抓了...

---

## 04:00

開工

### Global.asax

首先 `Global.asax` 整支 `Portal API` 的專案起始點，

使用到 `Autofac` 框架 實現 `IOC / DI Container`，

這個以前看 [以Asp .Net MVC 5 為基礎，建立自己的程式開發框架](https://ithelp.ithome.com.tw/users/20083151/ironman/856) 時有看到，但其實有點遺忘了，

當初後端好像都沒寫筆記，有空再看起來。

> Register 暫存器是中央處理器內用來暫存指令、資料和位址的電腦記憶體。

`Register()` 主要是在設定並啟用這個框架

接著是

`GlobalConfiguration.Configure(WebApiConfig.Register);`

看文章似乎是 MVC 轉 API 專案需要的設定檔，

<https://blog.miniasp.com/post/2015/02/18/How-to-Add-Web-API-to-ASPNET-MVC>

<https://stackoverflow.com/questions/40004657/webapiconfig-register-vs-globalconfiguration-configure>

WebApiConfig 內有寫一層路由，這層的感覺比較像是原始的

```C#
class WebApiConfig

name: "DefaultApi",
routeTemplate: "api/{fileName}/{nameSpaceName}/{className}/{methodName}/{*pathInfo}",
defaults: new
   {
      controller = "MxicApiHost",
      id = RouteParameter.Optional
   }
```

接著就來到 `RouteConfig.RegisterRoutes(RouteTable.Routes);`

<https://dotblogs.com.tw/h091237557/2014/08/14/146260>

```C#
routes.IgnoreRoute("{resource}.axd/{*pathInfo}");

routes.MapRoute(
   name: "Default",
   url: "{controller}/{action}/{id}",
   defaults: new { controller = "Home", action = "Index", id = UrlParameter.Optional }
);
```

目前判斷是兩套規則，一套 for API 一套 for 原來的 MVC 預設 router 而第二套就是其二

> IgnoreRoute : 『忽略』比對到的網址，忽略的意思是不進入 MvcHandler 會當成一般的 ASP.NET 網頁來執行。
>
> UrlParameter.Optional : 表示包含可选参数的只读值。可选参数的意思是所设置的参数不是必须要设置的，可以不传。

<https://shiyousan.com/post/635751704906562507>

`Global.asax - GlobalConfiguration` 檔案主要用來處理更高級別的應用程式事件。

`GlobalConfiguration.Configuration.Formatters.XmlFormatter.SupportedMediaTypes.Clear();`

ASP.NET Web API 無論任何要求都回應 JSON 格式

<https://blog.miniasp.com/post/2012/10/12/ASPNET-Web-API-Force-return-JSON-format-instead-of-XML-for-Google-Chrome-Firefox-Safari>

> !MX_BACKWARD_COMPATIBLE : 不??向下兼容

這裡應該是專案的獨立設定檔案，也沒寫啥註解看不太懂

```C#
 if (!MXSettings.MX_BACKWARD_COMPATIBLE)
            {
                // 設定 MembershipStore, 代入系統權限資源
                var membershipStore = new Mxic.Framework.Essential.OracelMembershipStore(SystemResource.GetResources());
                // 設定系統選單
                var menuStore = new Mxic.Framework.Essential.OracleMenuStore(new MenuService(), membershipStore);
                // 設定 ApiHostBase
                ApiHostBase.Setup(membershipStore, menuStore);

                /* ======================================
                 * 視系統需要建立admin帳號及角色
                 * 1. 建立 admin User
                 * 2. 建立 Admin Role
                 * ======================================*/
                //ApiHostBase.APInitial(adminPassword: "1234");
            }
```

## 05:30

被主管念了，有點走錯方向與進度太慢

目前被交派新任務是，前端直接在 Portal 資訊服務申請 / 異動，帳號權限 - 申請 - 申請項目與申請子項目，找 bug 並嘗試更改

可能後續要接 FTP ?

---

如何找後端 api 路徑

![img](../img/webapirouter.png)

<a href="../img/webapirouter.png">圖片位址</a>

不過覺得還是至少要知道 Controller 如何異動，

先補剛剛主管說的 前端架構

![img](/sinda-notes/img/ngF2Efilemap.png)

## 06:04

可以怎麼做 ?

在站台架起來後 先測試看哪幾筆會有問題，再利用那幾筆的關鍵字

來 check 相對應資料流，可能出錯是在後端還前端。

## 總結

回到 0620 的結論為何需要 db dictionary ，跟之前串雅虎與 momo api 狀況類似，

當專案夠大的時候會不知道欄位如何命名，因為對程式來說都必須是唯一值。

大致看 DB 並不會比之前電商的複雜，電商的畢竟是幾十年的沒有 DBA 的狀況的累積...

好處大概是不用再處理啥查報表這件事了，可以更多的接觸程式邏輯/架構/畫面端。

---

合作有很多種，不一定是系統商全出人員 上到下 SA PM DB RD PG ... 都有可能是乙方派遣，看合約怎談，

合約很重要"中文英文"都很重要，關乎賠錢 ? 新核打 ? 新美琪 ?

---

看 code 也有點硬，感覺用到很多設計模式，是說如果這樣學起來就會很多東西 !!

看了一些後心得是，大概就像 輔 X 資訊中心的，後端架構一樣，就是由一個懂得還算多的工程師去架設出來，

差別應該就在於輔 X 專案的前端是由可能更新的或更沒原則性的工程師所架設...

前端其實就跟後端一樣，後端規則較死遵循著做就好，但前端 REACT VUE 這種自主性高的框架，就會變成整個很有個人專案風格，

除非註解或文件很齊全，不然就跟摸天書一樣... 難怪前端薪水那麼高 ??

---

## 05:35

看來這就是系統商的壞處體現，因為需要直接做出點 KPI ，且案子也是從前人接下拼拼湊湊，所以不用了解整個專案架構，只要大概知道即可，然後要能夠改的動，感覺大致資料流與邏輯都知道了，目前也是被交派先修 BUG 而不是刻東西，所以應該是還可以吧... ?
